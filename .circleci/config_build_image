version: 2.1

executors:
  docker-executor:
    docker:
    - image: circleci/python:3.9 # Base image, can be changed

jobs:
  build-and-push:
    executor: docker-executor
    steps:
    - checkout

    - setup_remote_docker:
        version: 20.10.14 # Ensures Docker is available

    - run:
        name: Install AWS CLI
        command: |
          sudo apt-get update && sudo apt-get install -y awscli

    - run:
        name: Authenticate with AWS ECR
        command: |
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

    - run:
        name: Build Docker Image
        command: |
          docker build -t $ECR_REPOSITORY -f Tasky/Dockerfile Tasky

    - run:
        name: Tag Docker Image
        command: |
          docker tag $ECR_REPOSITORY:latest $ECR_REGISTRY/$ECR_REPOSITORY:latest

    - run:
        name: Push Docker Image to AWS ECR
        command: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

workflows:
  version: 2
  build-and-push:
    jobs:
    - build-and-push
